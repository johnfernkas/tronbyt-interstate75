name: Build MicroPython Firmware

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    
    strategy:
      matrix:
        include:
          - board: "i75w_rp2350"
            display_size: "64x32"
          - board: "i75w_rp2350"
            display_size: "64x64"
    
    env:
      MICROPYTHON_VERSION: "master"
      PIMORONI_PICO_VERSION: "feature/picovector2-and-layers"
    
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential git ccache python3-pip
          pip3 install littlefs-python
      
      - name: Install Arm GNU Toolchain
        uses: carlosperate/arm-none-eabi-gcc-action@v1
        with:
          release: '14.2.Rel1'
      
      - name: Checkout Tronbyt RP2350
        uses: actions/checkout@v4
        with:
          path: tronbyt-rp2350
      
      - name: Checkout MicroPython
        uses: actions/checkout@v4
        with:
          repository: micropython/micropython
          ref: ${{ env.MICROPYTHON_VERSION }}
          path: micropython
          submodules: recursive
      
      - name: Checkout Pimoroni Pico Libraries
        uses: actions/checkout@v4
        with:
          repository: pimoroni/pimoroni-pico
          ref: ${{ env.PIMORONI_PICO_VERSION }}
          path: pimoroni-pico
          submodules: true
      
      - name: Checkout Pimoroni Interstate75
        uses: actions/checkout@v4
        with:
          repository: pimoroni/interstate75
          path: interstate75
          submodules: true
      
      - name: Build mpy-cross
        run: |
          cd micropython/mpy-cross
          make -j$(nproc)
      
      - name: Create webpdec usermod.cmake
        run: |
          # Create usermod.cmake for webpdec
          cat > $GITHUB_WORKSPACE/tronbyt-rp2350/webpdec/usermod.cmake << 'EOF'
          add_library(usermod_webpdec INTERFACE)
          
          target_sources(usermod_webpdec INTERFACE
              ${CMAKE_CURRENT_LIST_DIR}/webpdec.c
          )
          
          target_include_directories(usermod_webpdec INTERFACE
              ${CMAKE_CURRENT_LIST_DIR}
          )
          
          target_link_libraries(usermod INTERFACE usermod_webpdec)
          EOF
      
      - name: Prepare Python modules for freezing
        run: |
          # Create modules directory structure for freezing
          MODULES_DIR=$GITHUB_WORKSPACE/tronbyt-rp2350/modules
          mkdir -p $MODULES_DIR
          
          # Copy Python files to modules directory
          cp $GITHUB_WORKSPACE/tronbyt-rp2350/config.py $MODULES_DIR/
          cp $GITHUB_WORKSPACE/tronbyt-rp2350/provisioning.py $MODULES_DIR/
          cp $GITHUB_WORKSPACE/tronbyt-rp2350/main.py $MODULES_DIR/
          
          # Create boot.py that runs our main module
          cat > $MODULES_DIR/boot.py << 'EOF'
          # Tronbyt RP2350 Boot Script
          # This runs automatically on startup and launches the main application
          
          try:
              import main
          except Exception as e:
              import sys
              print("Error starting Tronbyt:", e)
              sys.print_exception(e)
          EOF
          
          # Create a frozen manifest that includes our modules
          # Use the directory path for the modules
          cat > $GITHUB_WORKSPACE/tronbyt-rp2350/manifest.py << EOF
          # Include the default manifest
          include("$(PORT_DIR)/boards/manifest.py")
          
          # Freeze our application modules from the modules directory
          module("$MODULES_DIR/boot.py")
          module("$MODULES_DIR/config.py")
          module("$MODULES_DIR/provisioning.py")
          module("$MODULES_DIR/main.py")
          EOF
          
          echo "✅ Python modules prepared for freezing"
          ls -la $MODULES_DIR/
      
      - name: Configure build
        run: |
          BOARD=${{ matrix.board }}
          BOARD_DIR=$GITHUB_WORKSPACE/interstate75/boards/$BOARD
          BUILD_DIR=$GITHUB_WORKSPACE/build-$BOARD
          
          echo "Building for board: $BOARD"
          echo "Board directory: $BOARD_DIR"
          
          # Create build directory
          mkdir -p $BUILD_DIR
          
          # Configure with cmake - combining Interstate75 modules with webpdec
          cmake -S $GITHUB_WORKSPACE/micropython/ports/rp2 -B $BUILD_DIR \
            -DPICOTOOL_FORCE_FETCH_FROM_GIT=1 \
            -DPICO_BUILD_DOCS=0 \
            -DPICO_NO_COPRO_DIS=1 \
            -DPIMORONI_PICO_PATH=$GITHUB_WORKSPACE/pimoroni-pico \
            -DUSER_C_MODULES="$GITHUB_WORKSPACE/interstate75/boards/usermod-common.cmake;$GITHUB_WORKSPACE/tronbyt-rp2350/webpdec/usermod.cmake" \
            -DMICROPY_BOARD_DIR=$BOARD_DIR \
            -DMICROPY_BOARD=$BOARD \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DFROZEN_MANIFEST=$GITHUB_WORKSPACE/tronbyt-rp2350/manifest.py \
            -DMICROPY_FROZEN_MANIFEST=$GITHUB_WORKSPACE/tronbyt-rp2350/manifest.py
      
      - name: Build firmware
        run: |
          BOARD=${{ matrix.board }}
          BUILD_DIR=$GITHUB_WORKSPACE/build-$BOARD
          
          # Build
          cmake --build $BUILD_DIR -j$(nproc)
          
          # Rename output
          cp $BUILD_DIR/firmware.uf2 $GITHUB_WORKSPACE/tronbyt-rp2350-${{ matrix.display_size }}.uf2
      
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: tronbyt-rp2350-${{ matrix.display_size }}
          path: tronbyt-rp2350-${{ matrix.display_size }}.uf2
          retention-days: 30
      
      - name: Display build info
        run: |
          echo "✅ Build completed successfully!"
          echo "Board: ${{ matrix.board }}"
          echo "Display: ${{ matrix.display_size }}"
          ls -lh *.uf2
