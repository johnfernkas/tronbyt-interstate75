name: Build MicroPython Firmware

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    
    strategy:
      matrix:
        include:
          - board: "i75w_rp2350"
            display_size: "64x32"
          - board: "i75w_rp2350"
            display_size: "64x64"
    
    env:
      MICROPYTHON_VERSION: "master"
      PIMORONI_PICO_VERSION: "feature/picovector2-and-layers"
    
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential git ccache python3-pip
          pip3 install littlefs-python
      
      - name: Install Arm GNU Toolchain
        uses: carlosperate/arm-none-eabi-gcc-action@v1
        with:
          release: '14.2.Rel1'
      
      - name: Checkout Tronbyt RP2350
        uses: actions/checkout@v4
        with:
          path: tronbyt-rp2350
      
      - name: Checkout MicroPython
        uses: actions/checkout@v4
        with:
          repository: micropython/micropython
          ref: ${{ env.MICROPYTHON_VERSION }}
          path: micropython
          submodules: recursive
      
      - name: Checkout Pimoroni Pico Libraries
        uses: actions/checkout@v4
        with:
          repository: pimoroni/pimoroni-pico
          ref: ${{ env.PIMORONI_PICO_VERSION }}
          path: pimoroni-pico
          submodules: true
      
      - name: Checkout Pimoroni Interstate75
        uses: actions/checkout@v4
        with:
          repository: pimoroni/interstate75
          path: interstate75
          submodules: true
      
      - name: Build mpy-cross
        run: |
          cd micropython/mpy-cross
          make -j$(nproc)
      
      - name: Create webpdec usermod.cmake
        run: |
          # Create usermod.cmake for webpdec
          cat > $GITHUB_WORKSPACE/tronbyt-rp2350/webpdec/usermod.cmake << 'EOF'
          add_library(usermod_webpdec INTERFACE)
          
          target_sources(usermod_webpdec INTERFACE
              ${CMAKE_CURRENT_LIST_DIR}/webpdec.c
          )
          
          target_include_directories(usermod_webpdec INTERFACE
              ${CMAKE_CURRENT_LIST_DIR}
          )
          
          target_link_libraries(usermod INTERFACE usermod_webpdec)
          EOF
      
      - name: Prepare frozen modules
        run: |
          # Create modules directory for frozen Python files
          MODULES_DIR=$GITHUB_WORKSPACE/tronbyt-rp2350/modules
          mkdir -p $MODULES_DIR
          
          # Copy Python files to modules directory for freezing
          # _boot.py - frozen boot module that runs first
          cp $GITHUB_WORKSPACE/tronbyt-rp2350/_boot.py $MODULES_DIR/
          
          # config.py - default configuration (frozen)
          cp $GITHUB_WORKSPACE/tronbyt-rp2350/config.py $MODULES_DIR/
          
          # provisioning.py - WiFi provisioning module (frozen)
          cp $GITHUB_WORKSPACE/tronbyt-rp2350/provisioning.py $MODULES_DIR/
          
          # Create the frozen manifest using freeze() syntax
          # freeze() is the correct function for frozen modules (not module())
          cat > $GITHUB_WORKSPACE/tronbyt-rp2350/frozen_manifest.py << EOF
          # Frozen module manifest
          # Use freeze() for frozen modules, not module()
          
          # Include base board manifest
          include("\$(PORT_DIR)/boards/manifest.py")
          
          # Include Pimoroni modules if available
          try:
              include("\$(PIMORONI_PICO_PATH)/micropython/modules/micropython-common-manifest.cmake")
          except:
              pass
          
          # Freeze our modules
          freeze("$MODULES_DIR", "_boot.py")
          freeze("$MODULES_DIR", "config.py")
          freeze("$MODULES_DIR", "provisioning.py")
          EOF
          
          echo "✅ Frozen modules prepared"
          ls -la $MODULES_DIR/
          echo ""
          echo "Manifest content:"
          cat $GITHUB_WORKSPACE/tronbyt-rp2350/frozen_manifest.py
      
      - name: Create filesystem image with main.py
        run: |
          # Create a LittleFS filesystem image containing main.py
          # This allows main.py to be on the filesystem while other modules are frozen
          
          FS_DIR=$GITHUB_WORKSPACE/tronbyt-rp2350/fs_contents
          mkdir -p $FS_DIR
          
          # Copy main.py to filesystem
          cp $GITHUB_WORKSPACE/tronbyt-rp2350/main.py $FS_DIR/
          
          # Create boot.py for filesystem (runs after frozen _boot.py)
          cat > $FS_DIR/boot.py << 'EOF'
          # Filesystem boot.py - runs after frozen _boot.py
          # This file is optional - the frozen _boot.py handles launching main.py
          print("[FS-BOOT] Filesystem boot.py executing")
          print("[FS-BOOT] Main application should be started by frozen _boot.py")
          EOF
          
          echo "✅ Filesystem contents prepared:"
          ls -la $FS_DIR/
      
      - name: Configure build
        run: |
          BOARD=${{ matrix.board }}
          BOARD_DIR=$GITHUB_WORKSPACE/interstate75/boards/$BOARD
          BUILD_DIR=$GITHUB_WORKSPACE/build-$BOARD
          
          echo "Building for board: $BOARD"
          echo "Board directory: $BOARD_DIR"
          echo "Display size: ${{ matrix.display_size }}"
          
          # Create build directory
          mkdir -p $BUILD_DIR
          
          # Configure with cmake
          cmake -S $GITHUB_WORKSPACE/micropython/ports/rp2 -B $BUILD_DIR \
            -DPICOTOOL_FORCE_FETCH_FROM_GIT=1 \
            -DPICOTOOL_NO_PICOTOOL_TESTS=1 \
            -DPICO_BUILD_DOCS=0 \
            -DPICO_NO_COPRO_DIS=1 \
            -DPIMORONI_PICO_PATH=$GITHUB_WORKSPACE/pimoroni-pico \
            -DUSER_C_MODULES="$GITHUB_WORKSPACE/interstate75/boards/usermod-common.cmake;$GITHUB_WORKSPACE/tronbyt-rp2350/webpdec/usermod.cmake" \
            -DMICROPY_BOARD_DIR=$BOARD_DIR \
            -DMICROPY_BOARD=$BOARD \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DFROZEN_MANIFEST=$GITHUB_WORKSPACE/tronbyt-rp2350/frozen_manifest.py \
            -DDISPLAY_SIZE=${{ matrix.display_size }}
      
      - name: Build firmware
        run: |
          BOARD=${{ matrix.board }}
          BUILD_DIR=$GITHUB_WORKSPACE/build-$BOARD
          
          # Build
          cmake --build $BUILD_DIR -j$(nproc)
          
          # Check if firmware was created
          if [ -f "$BUILD_DIR/firmware.uf2" ]; then
            echo "✅ Firmware built successfully"
            cp $BUILD_DIR/firmware.uf2 $GITHUB_WORKSPACE/tronbyt-rp2350-${{ matrix.display_size }}.uf2
          else
            echo "❌ Firmware not found at expected location"
            find $BUILD_DIR -name "*.uf2" -type f 2>/dev/null || echo "No .uf2 files found"
            exit 1
          fi
      
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: tronbyt-rp2350-${{ matrix.display_size }}
          path: tronbyt-rp2350-${{ matrix.display_size }}.uf2
          retention-days: 30
      
      - name: Upload filesystem contents artifact
        uses: actions/upload-artifact@v4
        with:
          name: tronbyt-rp2350-fs-${{ matrix.display_size }}
          path: |
            tronbyt-rp2350/fs_contents/main.py
            tronbyt-rp2350/fs_contents/boot.py
          retention-days: 30
      
      - name: Display build info
        run: |
          echo "✅ Build completed successfully!"
          echo "Board: ${{ matrix.board }}"
          echo "Display: ${{ matrix.display_size }}"
          ls -lh *.uf2 || echo "No .uf2 files in workspace root"
          echo ""
          echo "Filesystem contents:"
          ls -la $GITHUB_WORKSPACE/tronbyt-rp2350/fs_contents/
